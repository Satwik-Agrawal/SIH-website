<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Report an Issue</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .report-container {
      max-width: 600px;
      margin: 30px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 16px;
      box-sizing: border-box;
    }
    .form-group textarea {
      height: 100px;
      resize: vertical;
    }
    .btn {
      width: 100%;
      padding: 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    .btn:hover {
      background: #0056b3;
    }
    .btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: center;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .camera-section {
      border: 2px dashed #ddd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin: 15px 0;
    }
    .camera-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin: 5px;
    }
    .camera-btn:hover {
      background: #218838;
    }
    .preview-image {
      max-width: 100%;
      max-height: 200px;
      border-radius: 5px;
      margin-top: 10px;
    }
    .ai-suggestion {
      background: #e3f2fd;
      border: 1px solid #2196f3;
      border-radius: 5px;
      padding: 10px;
      margin: 10px 0;
    }
    .ai-suggestion h4 {
      margin: 0 0 5px 0;
      color: #1976d2;
    }
    .ai-suggestion p {
      margin: 0;
      font-size: 14px;
    }
    .back-link {
      display: inline-block;
      margin-bottom: 20px;
      color: #007bff;
      text-decoration: none;
    }
    .back-link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="report-container">
    <a href="index.html" class="back-link">‚Üê Back to Home</a>
    <h1 style="text-align: center; margin-bottom: 30px;">Report an Issue</h1>
    
    <div id="reportMessage" class="message" style="display: none;"></div>
    
    <form id="reportForm">
      <div class="form-group">
        <label for="issueTitle">Title <span style="color: red;">*</span></label>
        <input type="text" id="issueTitle" placeholder="Brief description of the issue" required>
      </div>

      <div class="form-group">
        <label for="issueDesc">Description <span style="color: red;">*</span></label>
        <textarea id="issueDesc" placeholder="Detailed description of the issue" required></textarea>
      </div>

      <div class="form-group">
        <label for="issueLocation">Location <span style="color: red;">*</span></label>
        <input type="text" id="issueLocation" placeholder="e.g. Near Gate 3, Main Street" required>
      </div>

      <div class="form-group">
        <label for="issueCategory">Category <span style="color: red;">*</span></label>
        <select id="issueCategory" required>
          <option value="">--Select Category--</option>
          <option value="Roads">Roads</option>
          <option value="Infrastructure">Infrastructure</option>
          <option value="Sanitation">Sanitation</option>
          <option value="Garbage">Garbage</option>
          <option value="Electricity">Electricity</option>
          <option value="Water">Water</option>
          <option value="Other">Other</option>
        </select>
      </div>

      <div class="form-group">
        <label>Photo</label>
        <div class="camera-section">
          <p>Take a photo or upload an image</p>
          <button type="button" class="camera-btn" id="cameraBtn">üì∑ Take Photo</button>
          <button type="button" class="camera-btn" id="uploadBtn">üìÅ Upload Image</button>
          <input type="file" id="issueImage" accept="image/*" style="display: none;">
          <div id="imagePreview"></div>
        </div>
      </div>

      <div id="aiSuggestion" class="ai-suggestion" style="display: none;">
        <h4>ü§ñ AI Suggestion</h4>
        <p id="aiSuggestionText"></p>
        <button type="button" id="useAISuggestion" class="camera-btn" style="background: #2196f3;">Use This Category</button>
      </div>

      <button type="submit" class="btn" id="submitBtn">Submit Report</button>
    </form>
  </div>

  <script src="api-client.js"></script>
  <script>
    // Check authentication
    if (!apiClient.isAuthenticated()) {
      window.location.href = 'login.html';
    }

    const form = document.getElementById('reportForm');
    const cameraBtn = document.getElementById('cameraBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const imageInput = document.getElementById('issueImage');
    const imagePreview = document.getElementById('imagePreview');
    const aiSuggestion = document.getElementById('aiSuggestion');
    const aiSuggestionText = document.getElementById('aiSuggestionText');
    const useAISuggestion = document.getElementById('useAISuggestion');
    const categorySelect = document.getElementById('issueCategory');
    const submitBtn = document.getElementById('submitBtn');

    let selectedImage = null;

    // Camera functionality
    cameraBtn.addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const video = document.createElement('video');
        video.style.width = '100%';
        video.style.maxHeight = '200px';
        video.srcObject = stream;
        video.play();

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        const captureBtn = document.createElement('button');
        captureBtn.textContent = 'üì∏ Capture';
        captureBtn.className = 'camera-btn';
        captureBtn.style.background = '#dc3545';

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = '‚ùå Cancel';
        cancelBtn.className = 'camera-btn';
        cancelBtn.style.background = '#6c757d';

        imagePreview.innerHTML = '';
        imagePreview.appendChild(video);
        imagePreview.appendChild(captureBtn);
        imagePreview.appendChild(cancelBtn);

        captureBtn.addEventListener('click', () => {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          context.drawImage(video, 0, 0);
          
          canvas.toBlob(blob => {
            selectedImage = blob;
            const img = document.createElement('img');
            img.src = URL.createObjectURL(blob);
            img.className = 'preview-image';
            imagePreview.innerHTML = '';
            imagePreview.appendChild(img);
            
            // Analyze image with AI
            analyzeImage(blob);
          }, 'image/jpeg', 0.8);
          
          stream.getTracks().forEach(track => track.stop());
        });

        cancelBtn.addEventListener('click', () => {
          stream.getTracks().forEach(track => track.stop());
          imagePreview.innerHTML = '';
        });

      } catch (error) {
        showMessage('Camera access denied or not available', 'error');
      }
    });

    // Upload functionality
    uploadBtn.addEventListener('click', () => {
      imageInput.click();
    });

    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedImage = file;
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.className = 'preview-image';
        imagePreview.innerHTML = '';
        imagePreview.appendChild(img);
        
        // Analyze image with AI
        analyzeImage(file);
      }
    });

    // AI Image Analysis (mock implementation)
    async function analyzeImage(imageBlob) {
      // In a real implementation, you would send the image to an AI service
      // For now, we'll simulate AI analysis
      setTimeout(() => {
        const categories = ['Roads', 'Garbage', 'Water', 'Electricity', 'Infrastructure', 'Sanitation'];
        const randomCategory = categories[Math.floor(Math.random() * categories.length)];
        const confidence = (Math.random() * 0.4 + 0.6).toFixed(2); // 60-100% confidence
        
        aiSuggestionText.textContent = `Based on the image analysis, this appears to be a "${randomCategory}" issue (${(confidence * 100).toFixed(0)}% confidence).`;
        aiSuggestion.style.display = 'block';
        
        useAISuggestion.onclick = () => {
          categorySelect.value = randomCategory;
          aiSuggestion.style.display = 'none';
        };
      }, 1000);
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const title = document.getElementById('issueTitle').value.trim();
      const description = document.getElementById('issueDesc').value.trim();
      const location = document.getElementById('issueLocation').value.trim();
      const category = document.getElementById('issueCategory').value;

      if (!title || !description || !location || !category) {
        showMessage('Please fill in all required fields', 'error');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      try {
        const issueData = {
          title,
          description,
          location,
          category,
          image: selectedImage
        };

        const result = await apiClient.createIssue(issueData);
        
        if (result.success) {
          showMessage('Issue reported successfully! Redirecting...', 'success');
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
        } else {
          showMessage(result.error || 'Failed to submit report', 'error');
        }
      } catch (error) {
        showMessage('Error submitting report', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Report';
      }
    });

    function showMessage(message, type) {
      const messageDiv = document.getElementById('reportMessage');
      messageDiv.textContent = message;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
    }
  </script>
</body>
</html>
